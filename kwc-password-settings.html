<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../kwc-style/kwc-style.html">
<link rel="import" href="../kwc-button/kwc-button.html">
<link rel="import" href="../kwc-behaviours/kano-validation.html">

<!--
`kwc-password-settings`

A small component to allow users to update their password.

@demo demo/index.html
-->

<dom-module id="kwc-password-settings">
    <template>
        <style is="custom-style" include="input-text">
        <style>
            :host {
                display: block;
            }
            :host h3 {
                color: var(--color-black);
                font-family: var(--font-heading);
                font-size: 18px;
                margin: 0 0 32px 0;
                text-transform: uppercase;
            }
            :host p,
            :host li {
                font-family: var(--font-body);
            }
            :host .content {
                position: relative;
            }
            :host form {
                @apply --layout-vertical;
                @apply --layout-start-justified;
                @apply --layout-start;
            }
            :host input {
                @apply var(--kwc-input-base);
                margin-bottom: 16px;
                width: 100%;
            }
            :host input[kwc-valid] {
                border-color: var(--color-grassland);
            }
            :host input[kwc-invalid] {
                border-color: var(--color-cinnabar);
            }
            :host .errors {
                @apply --layout-flex-auto;
                color: var(--color-cinnabar);
                list-style: none;
                margin: 16px 0 32px 0;
                min-height: 16px;
                padding: 0;
            }
            :host .error ~ .error {
                margin-top: 8px;
            }
            :host .overlay {
                @apply --layout-fit;
                background-color: white;
                margin: auto;
                text-align: center;
            }
            :host .overlay-label {
                color: var(--color-abbey);
                font-size: 16px;
                font-family: var(--font-body);
                font-weight: bold;
                margin: 0;
                padding-bottom: 24px;
            }
            :host paper-spinner-lite {
                display: block;
                margin: auto;
            }
            :host *[hidden] {
                display: none !important;
            }
        </style>
        <h3>Password</h3>
        <div class="content">
            <form on-submit="_updatePassword">
                <input id="_current"
                       type="password"
                       value="{{_current::input}}"
                       on-focus="_clearErrors"
                       on-keyup="_validateCurrent"
                       placeholder="Your current password"
                       kwc-valid$="[[_inputValid(_validations._current, _current)]]"
                       kwc-invalid$="[[_inputInvalid(_validations._current, _current)]]"
                       required />
                <input id="_update"
                       type="password"
                       value="{{_update::input}}"
                       on-focus="_clearErrors"
                       on-keyup="_validateUpdate"
                       placeholder="Your new password"
                       kwc-valid$="[[_inputValid(_validations._update, _update)]]"
                       kwc-invalid$="[[_inputInvalid(_validations._update, _update)]]"
                       required />
                <input id="_confirmation"
                       type="password"
                       value="{{_confirmation::input}}"
                       on-focus="_clearErrors"
                       on-keyup="_validateConfirmation"
                       placeholder="Please confirm your password"
                       kwc-valid$="[[_inputValid(_validations._confirmation, _confirmation)]]"
                       kwc-invalid$="[[_inputInvalid(_validations._confirmation, _confirmation)]]"
                       required />
                <ul class="errors">
                     <template is="dom-repeat" items="[[_errorMessages]]">
                        <li class="error">[[item]]</li>
                     </template>
                </ul>
                <kwc-button disabled$="[[!valid]]"
                            type="submit"
                            variant="tertiary"
                            square
                            on-tap="_updatePassword">
                    Update
                </kwc-button>
            </form>
            <template is="dom-if" if="[[updating]]">
                <div class="overlay loader">
                    <p class="overlay-label">Loading...</p>
                    <paper-spinner-lite active="[[updating]]">
                    </paper-spinner-lite>
                </div>
            </template>
            <template is="dom-if" if="[[_updateError]]">
                <div class="overlay error">
                    <p class="overlay-label">Sorry, something went wrong.</p>
                    <kwc-button type="button"
                                variant="primary"
                                square
                                on-tap="_reset">
                        Try again
                    </kwc-button>
                </div>
            </template>
            <template is="dom-if" if="[[updated]]">
                <div class="overlay success">
                    <p class="overlay-label">Success! Your password has been updated.</p>
                    <kwc-button type="button"
                                variant="primary"
                                square
                                on-tap="_reset">
                        Got it
                    </kwc-button>
                </div>
            </template>
        </div>
    </template>

    <script>
      Polymer({
          is: 'kwc-password-settings',
          behaviors: [
              Kano.Validation.Behaviour
          ],
          properties: {
              /** The user's current password */
              _current: {
                  type: String,
                  value: ''
              },
              /** The update error (if applicable) */
              error: {
                  type: String
              },
              /** The errors for each field in the form */
              errors: {
                  type: Object,
                  value: () => {
                      return {}
                  }
              },
              /** An array of error messages computed from the errors object */
              _errorMessages: {
                  type: Array,
                  computed: '_computedErrorMessages(errors.*)'
              },
              /** The user's new password (confirmed) */
              _confirmation: {
                  type: String,
                  value: ''
              },
              /** The user's new password */
              _update: {
                  type: String,
                  value: ''
              },
              /**
               * Boolean to indicate whether there has been an error with
               * the update
               */
              _updateError: {
                  type: Boolean,
                  computed: '_computeUpdateError(error)'
              },
              /** Boolean to indicate whether the email has been updated */
              updated: {
                  type: Boolean,
                  value: false
              },
              /** Boolean to indicate whether the email is updating */
              updating: {
                  type: Boolean,
                  value: false
              },
              /** Whether the form component is valid */
              valid: {
                  type: Boolean,
                  computed: '_computeValidity(_validations.*)',
                  notify: true
              },
              /** The validation status for each field in the form */
              _validations: {
                  type: Object,
                  value: () => {
                      return {
                          _current: false,
                          _confirmation: false,
                          _update: false
                      }
                  }
              }
          },
          /**
           * Clear all errors when the user begins submitting a field
           * @param {Event} e The focus event from the text input
           */
          _clearErrors (e) {
              this.set('errors.password', null);
              this.set(`errors.${e.target.id}`, null);
          },
          /**
           * Generate an array of error messages from the errors object
           * @param {Object} errors
           * @returns {Array}
           */
          _computedErrorMessages (errors) {
              let messages = [];
              if (!errors || !errors.base) {
                  return messages;
              }
              for (let type in errors.base) {
                  messages.push(errors.base[type]);
              }
              return messages.filter(message => {
                  return message !== null && message !== undefined;
              });
          },
          /**
           * Return a boolean to indicate whether there is an update error
           * @param {String} error
           * @returns {Boolean}
           */
          _computeUpdateError (error) {
              return error && error.length ? true : false;
          },
          /**
           * Compute whether the input is invalid
           * @param {Boolean} validation The validation for this field
           * @param {String} property The text input value
           * @returns {Boolean}
           */
          _inputInvalid (validation, property) {
              let fieldSet = property && property.length ? true : false;
              return fieldSet && !validation;
          },
          /**
           * Compute whether the input is valid
           * @param {Boolean} validation The validation for this field
           * @param {String} property The text input value
           * @returns {Boolean}
           */
          _inputValid (validation, property) {
              return validation && property && property.length ? true : false;
          },
          /**
           * Check whether the component is valid – there are no invalid fields
           * @param {Object} validations Update from `validations` changes
           * @returns {Boolean}
           */
          _computeValidity (validations) {
              let valid = true;
              if (!validations || !validations.base) {
                  valid = false;
              } else {
                  for (let validation in validations.base) {
                      if (!validations.base[validation]) {
                          valid = false;
                      }
                  }
              }
              return valid;
          },
          /** Reset the component */
          _reset () {
              this.set('updated', false);
              this.set('updating', false);
              this.set('error', null);
              this.set('_current', '');
              this.set('_update', '');
              this.set('_confirmation', '');
              this.set('errors', {});
              this.set('_validations', {
                  _confirmation: false,
                  _update: false
              });
          },
          /**
           * Fire the event to the parent to update the password
           * @param {Event} e The submit event from the form
           */
          _updatePassword (e) {
              e.preventDefault();
              this.fire('update-password', {
                  current: this._current,
                  new: this._update
              });
          },
          /**
           * Validate that the confirmation password matches the main update
           * @param {Event} e The blur event from the input field
           */
          _validateConfirmation (e) {
              this.debounce('validate-confirmation', () => {
                  let element = e.path[0];
                  if (this._validatePassword(e, 0)) {
                      if (element.value === this._update) {
                          this.set('_validations._confirmation', true);
                          this.set('errors._confirmation', null);
                      } else {
                          this.set('_validations._confirmation', false);
                          this.set('errors._confirmation', 'The password confirmation does not match');
                      }
                  }
              }, 500);
          },
          /**
           * Validate that the current password with debouncer
           * @param {Event} e The blur event from the input field
           */
          _validateCurrent (e) {
              this.debounce('validate-current', () => {
                  this._validatePassword(e);
              }, 500);
          },
          /**
           * Validate that the new password is not the same as the old one
           * @param {Event} e The blur event from the input field
           */
          _validateUpdate (e) {
              this.debounce('validate-update', () => {
                  let element = e.path[0];
                  if (element.value === this._current) {
                      this.set('_validations._update', false);
                      this.set('errors._update', 'Your new password cannot be the same as your old one');
                  } else {
                      this._validatePassword(e);
                      this.set('errors._update', null);
                  }
              }, 500);
          },
          /**
           * Validate the password given
           * @param {Event} e The blur event from the input field
           * @returns {Boolean}
           */
          _validatePassword (e) {
              let element = e.path[0],
                  valid = this.validatePassword(element.value);
              this.set(`_validations.${element.id}`, valid);
              if (valid) {
                  this.set(`errors.${element.id}`, null);
                  this.set('errors.password', null);
              }
              return valid;
          }
      });
    </script>
</dom-module>
